import { NextRequest, NextResponse } from 'next/server';
import OpenAI from 'openai';
import fs from 'fs';
import path from 'path';

export async function POST(request: NextRequest) {
  try {
    const { message } = await request.json();

    if (!message) {
      return NextResponse.json(
        { error: 'Message is required' },
        { status: 400 }
      );
    }

    if (!process.env.OPENAI_API_KEY) {
      return NextResponse.json(
        { error: 'OpenAI API key not configured. Please add OPENAI_API_KEY to environment variables.' },
        { status: 500 }
      );
    }

    // Initialize OpenAI client
    const openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY,
    });

    // Load predictions data
    const filePath = path.join(process.cwd(), 'future_predictions_next_day.json');
    const fileContents = fs.readFileSync(filePath, 'utf8');
    const predictions = JSON.parse(fileContents);

    // Create a formatted context from predictions
    const predictionsContext = predictions.map((p: any) => {
      const signal =
        p.Predicted_Direction === 'UP' && p.Direction_Confidence > 60 ? 'STRONG BUY' :
        p.Predicted_Direction === 'UP' && p.Direction_Confidence >= 50 ? 'MODERATE BUY' :
        p.Predicted_Direction === 'DOWN' && p.Direction_Confidence > 60 ? 'STRONG SELL' :
        p.Predicted_Direction === 'DOWN' && p.Direction_Confidence >= 50 ? 'MODERATE SELL' :
        'HOLD';

      return `
Stock: ${p.Stock} (${p.Ticker})
Current Price: ₹${p.Current_Price.toFixed(2)}
Prediction: ${p.Predicted_Direction} with ${p.Direction_Confidence.toFixed(1)}% confidence
Signal: ${signal}
Expected Change: ${p.Predicted_Change_Pct >= 0 ? '+' : ''}${p.Predicted_Change_Pct.toFixed(2)}%
Predicted Price Range: ₹${p.Predicted_Price_Low.toFixed(2)} - ₹${p.Predicted_Price_High.toFixed(2)}
Mid-point: ₹${p.Predicted_Price_Mid.toFixed(2)}
Potential Gain/Loss: ₹${p.Potential_Gain_Loss_Mid >= 0 ? '+' : ''}${p.Potential_Gain_Loss_Mid.toFixed(2)}
      `.trim();
    }).join('\n\n---\n\n');

    const systemPrompt = `You are a helpful AI assistant for a stock price prediction platform. You have access to next-day predictions for 8 Indian bank stocks generated by advanced Transformer models.

Your role is to:
1. Answer questions about the stock predictions clearly and concisely
2. Provide trading insights based on the prediction data
3. Explain confidence levels and what they mean
4. Compare different stocks when asked
5. Give recommendations based on the signals (Strong Buy, Moderate Buy, Strong Sell, etc.)

IMPORTANT GUIDELINES:
- Always include the disclaimer that these are AI predictions and users should do their own research
- Mention confidence levels when discussing predictions
- Use rupee symbol (₹) for prices
- Be conversational but professional
- If asked about stocks not in the data, politely say you only have data for these 8 bank stocks

Here is the current prediction data:

${predictionsContext}

Remember: These predictions are for the NEXT TRADING DAY only and are based on historical data. Past performance does not guarantee future results.`;

    const completion = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: message }
      ],
      temperature: 0.7,
      max_tokens: 500,
    });

    const response = completion.choices[0]?.message?.content || 'Sorry, I could not generate a response.';

    return NextResponse.json({ response });

  } catch (error: any) {
    console.error('Chat API error:', error);
    return NextResponse.json(
      { error: error.message || 'Failed to process chat message' },
      { status: 500 }
    );
  }
}
